;; tests for WAE
(test (run "5") '(5))
(test (run "{+ 5 5}") '(10))
(test (run "{with {x {+ 5 5}} {+ x x}}") '(20))
(test (run "{with {x 5} {+ x x}}") '(10))
(test (run "{with {x {+ 5 5}} {with {y {- x 3}} {+ y y}}}") '(14))
(test (run "{with {x 5} {with {y {- x 3}} {+ y y}}}") '(4))
(test (run "{with {x 5} {+ x {with {x 3} 10}}}") '(15))
(test (run "{with {x 5} {+ x {with {x 3} x}}}") '(8))
(test (run "{with {x 5} {+ x {with {y 3} x}}}") '(10))
(test (run "{with {x 5} {with {y x} y}}") '(5))
(test (run "{with {x 5} {with {x x} x}}") '(5))
(test/exn (run "{with {x 1} y}") "free identifier")
(test (run "{with {x 2} {- {+ x x} x}}") '(2))
(test/exn (run "{with x = 2 {+ x 3}}") "bad syntax")
(test/exn (run "{bleh}") "bad syntax")

;; given tests for MUWAE
(test (run "{+ {1 2} {3 4}}") '(4 5 5 6))
(test (run "{- {+ {1 2} {3 4}} {1 2}}") '(3 2 4 3 4 3 5 4))
(test (run "{- {10 2 1} {3 2}}") '(7 8 -1 0 -2 -1))
(test (run "{with {x {1 2}} {+ x {4 3}}}") '(5 4 6 5))
(test (run "{with {x 9} {+ x {with {x 3} x}}}") '(12))
(test (run "{with {x 100} {+ x {with {y 3} x}}}") '(200))
(test (run "{with {x 5} {+ x {with {x 3} 10}}}") '(15))
(test (run "{with {x {7 5}} {+ x x}}") '(14 12 12 10))
(test (run "{with {x {1 2}} {+ x {4 3}}}") '(5 4 6 5))
(test (run "{with {x 2} {- {+ x x} x}}") '(2))
(test (run "{+ {muwae-min 3 5 7} {muwae-min 10 100 1000}}") '(13))
(test (run "{+ {muwae-min 9 3 7} {muwae-max 6 2 20}}") '(23))
(test (run "{with {x 10} {muwae-max x 2 3}}") '(10))
(test (run "{with {x 20} {with {y 5} {with {z {10 20}} {+ z {muwae-max {+ x y} 0 12}}}}}") '(35 45))
(test (run "{with {x 20} {with {y 5} {with {z {10 20}} {+ z {muwae-min {+ x y} 0 12}}}}}") '(10 20))
(test (run "{with {x {muwae-min 3 9 5}} {with {y {- x 3}} y}}") '(0))
(test (run "{with {x {muwae-max 2 3 5}} {muwae-min x 7 6}}") '(5))
(test (run "{with {x {muwae-max 9 7 10}} {muwae-max 8 x {+ 1 x}}}") '(11))
(test (run "{- {muwae-min 6 4 5} {muwae-max 2 3 4}}") '(0))
(test (run "{with {x {+ 7 2}} {muwae-min x 7 0}}") '(0))
(test (run "{+ {muwae-min 9 3 7} {muwae-max 6 2 20}}") '(23))
(test (run "{with {x {13}} {muwae-min x 1 12}}") '(1))
(test (run "{with {x {muwae-min 2 1 3}} {+ x x}}") '(2))
(test (run "{with {a 10} {with {b 19} {with {c 2} {muwae-min a b c}}}}") '(2))
(test (run "{with {x 3} {muwae-max 3 4 {+ x x}}}") '(6))
(test (run "{with {a 10} {with {b 19} {with {c 2} {muwae-max a b c}}}}") '(19))
(test (run "{with {x {muwae-min 2 5 4}} {+ x x}}") '(4))
(test (run "{with {x {muwae-max 2 5 4}} {+ x x}}") '(10))
(test (run "{with {x {- 11 3}} {muwae-max x {+ x x} {- x x}}}") '(16))
(test (run "{with {x {- 11 3}} {muwae-min x {+ x x} {- x x}}}") '(0))
(test (run "{muwae-min {+ 4 4} {with {x 5} {+ x {with {x 3} 10}}} 3}") '(3))
(test (run "{muwae-max {+ 4 4} {with {x 5} {+ x {with {x 3} 10}}} 3}") '(15))
(test (run "{with {x {13}} {muwae-min x 1 12}}") '(1))
(test (run "{with {x {10} } {muwae-max x 2 3}}") '(10))
(test (run "{with {x {muwae-min 2 1 3}} {+ x x}}") '(2))
(test (run "{with {x {muwae-max 2 1 3}} {+ x x}}") '(6))
(test (run "{with {x 2} {muwae-min x 3 10}}") '(2))
(test (run "{with {x 2} {muwae-max x 3 10}}") '(10))
(test (run "{muwae-min {+ 4 4} 2 3} ") '(2))
(test (run "{muwae-max {+ 4 4} 2 3} ") '(8))
(test (run "{with {x 10} {muwae-min x 2 3}}") '(2))
(test (run "{with {x 10} {muwae-max x 2 3}}") '(10))
(test (run "{with {x {10}} {muwae-max x 2 3}}") '(10))
(test (run "{muwae-min {+ 3 4} 5 6}") '(5))
(test (run "{muwae-max {+ 3 4} 5 6}") '(7))
(test (run "{with {x {10}} {muwae-min x {3} {5}}}") '(3))
(test (run "{with {x {10}} {muwae-max x {3} {5}}}") '(10))
(test (run "{muwae-min {3} 4 5}") '(3))
(test (run "{muwae-max {3} 4 {5}}") '(5))
(test (run "{+ {10 100 1000 10000} {muwae-min {- 3 4} 5 6}}") '(9 99 999 9999))

;; random generated tests for MUWAE
(test (run "{with {a {with {z {muwae-min {31} {73} {54}}} z}} {muwae-max {+ a a} {muwae-max a a a} a}}") '(62))
(test (run "{with {b {+ {57} {44}}} {muwae-min {muwae-min b b b} b b}}") '(101))
(test (run "{+ {+ {+ {16} {52}} {26}} {muwae-max {+ {54} {78}} {with {z {97}} z} {muwae-max {13} {93} {11}}}}") '(226))
(test (run "{with {b {+ {49} {+ {0} {90}}}} {with {y {muwae-min b b b}} b}}") '(139))
(test (run "{+ {+ {84} {with {z {94}} z}} {muwae-min {+ {41} {87}} {34} {78}}}") '(212))
(test (run "{muwae-max {with {c {+ {3} {45}}} {+ c c}} {+ {75} {34}} {with {a {with {y {18}} y}} a}}") '(109))
(test (run "{muwae-max {+ {61} {muwae-min {24} {40} {44}}} {muwae-min {muwae-max {97} {19} {82}} {+ {47} {44}} {9}} {with {c {53}} {with {c c} c}}}") '(85))
(test (run "{+ {muwae-max {muwae-max {80} {69} {80}} {muwae-max {5} {68} {59}} {12}} {muwae-min {with {x {52}} x} {muwae-max {45} {6} {12}} {with {a {41}} a}}}") '(121))
(test (run "{muwae-max {with {x {+ {68} {37}}} {+ x x}} {muwae-min {51} {with {a {22}} a} {+ {49} {72}}} {with {b {muwae-min {90} {74} {41}}} b}}") '(210))
(test (run "{muwae-max {+ {muwae-max {91} {84} {43}} {with {c {86}} c}} {muwae-min {55} {12} {muwae-min {26} {25} {38}}} {with {a {+ {87} {78}}} {+ a a}}}") '(330))
(test (run "{with {x {with {a {with {y {88}} y}} a}} {muwae-min x {muwae-max x x x} x}}") '(88))
(test (run "{with {a {muwae-max {+ {72} {6}} {muwae-min {22} {90} {21}} {62}}} {+ {muwae-max a a a} {muwae-min a a a}}}") '(156))
(test (run "{muwae-max {muwae-min {with {c {75}} c} {muwae-max {41} {91} {97}} {11}} {with {x {with {x {23}} x}} x} {+ {16} {with {b {34}} b}}}") '(50))
(test (run "{with {c {with {z {muwae-max {0} {97} {95}}} z}} {with {c {+ c c}} c}}") '(194))
(test (run "{+ {muwae-max {98} {+ {85} {33}} {with {y {62}} y}} {+ {with {x {61}} x} {89}}}") '(268))
(test (run "{muwae-max {muwae-max {muwae-min {27} {18} {62}} {muwae-min {34} {77} {1}} {muwae-max {3} {2} {14}}} {with {c {22}} {with {z c} z}} {+ {98} {+ {4} {73}}}}") '(175))
(test (run "{+ {with {z {92}} z} {+ {muwae-min {38} {72} {69}} {muwae-min {13} {68} {27}}}}") '(143))
(test (run "{muwae-min {+ {+ {98} {30}} {62}} {+ {58} {0}} {+ {7} {87}}}") '(58))
(test (run "{muwae-max {with {c {muwae-min {9} {86} {96}}} c} {+ {with {c {38}} c} {+ {53} {38}}} {muwae-min {muwae-max {57} {93} {99}} {71} {with {y {87}} y}}}") '(129))
(test (run "{with {c {+ {+ {64} {5}} {muwae-min {48} {68} {55}}}} {with {b c} {+ b c}}}") '(234))
(test (run "{muwae-max {muwae-max {33} {muwae-min {40} {31} {49}} {+ {16} {92}}} {with {a {muwae-min {76} {24} {9}}} a} {+ {muwae-min {32} {73} {67}} {95}}}") '(127))
(test (run "{+ {with {y {+ {67} {63}}} y} {with {x {+ {10} {12}}} x}}") '(152))
(test (run "{muwae-min {muwae-max {38} {muwae-max {3} {36} {49}} {+ {30} {84}}} {+ {+ {49} {20}} {69}} {+ {muwae-min {75} {68} {70}} {73}}}") '(114))
(test (run "{with {y {with {a {3}} a}} {+ {+ y y} {+ y y}}}") '(12))
(test (run "{muwae-min {with {x {60}} x} {with {y {72}} {+ y y}} {+ {21} {muwae-max {81} {80} {33}}}}") '(60))
(test (run "{with {z {+ {62} {muwae-min {25} {67} {39}}}} {muwae-min z {with {y z} z} z}}") '(87))
(test (run "{muwae-max {muwae-max {+ {25} {72}} {+ {82} {19}} {muwae-max {45} {62} {44}}} {muwae-min {69} {with {x {51}} x} {43}} {muwae-max {+ {15} {48}} {muwae-max {48} {35} {0}} {muwae-min {4} {54} {69}}}}") '(101))
(test (run "{muwae-min {+ {with {x {23}} x} {46}} {muwae-min {+ {19} {33}} {40} {muwae-min {72} {58} {82}}} {+ {+ {83} {30}} {82}}}") '(40))
(test (run "{+ {+ {+ {72} {44}} {+ {33} {7}}} {muwae-min {42} {+ {34} {27}} {with {c {27}} c}}}") '(183))
(test (run "{muwae-min {with {z {81}} {+ z z}} {muwae-max {66} {57} {6}} {+ {with {y {1}} y} {3}}}") '(4))
(test (run "{muwae-min {muwae-max {49} {4} {93}} {+ {with {x {19}} x} {+ {14} {91}}} {with {c {20}} c}}") '(20))
(test (run "{muwae-max {muwae-min {97} {83} {99}} {with {b {+ {24} {12}}} b} {+ {90} {with {b {58}} b}}}") '(148))
(test (run "{+ {+ {28} {muwae-min {50} {35} {45}}} {+ {94} {40}}}") '(197))
(test (run "{+ {+ {97} {77}} {+ {15} {+ {31} {49}}}}") '(269))
(test (run "{muwae-max {muwae-max {39} {92} {73}} {+ {62} {with {y {92}} y}} {+ {95} {68}}}") '(163))
